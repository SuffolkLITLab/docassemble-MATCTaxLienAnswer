---
#############
# Test cases
# MCQA02 â€“ 22 TL 000001
---
######
# TODO:
# * wth to do with the service? right now it's still mailing service,
#     * idk what MA does with e-service
# * Assuming "Answer (unspecified)" is the best option, no other tax lien specific options
# * Assuming things should default public for document type
# * "No" or "idk" should stop the interview
# 
# * "Address with property lien against it" comes at weird timing (we now
#   ask about case parties in case search too, so it splits those questions)
---
include:
  - docassemble.EFSPIntegration:efiling_integration.yml
  - docassemble.EFSPIntegration:case_search.yml
  - docassemble.EFSPIntegration:toga_payments.yml
---
code: |
  efile_case_category_filters = ["idk"]
  efile_case_category_exclude = None
  efile_case_category_default = None
  efile_case_type_filters = ["idk"]
  efile_case_type_default = None
  efile_case_type_exclude = None
---
code: |
  al_court_bundle.filing_type_filters = [
    "Taxlien Answer",
    ["Taxlien", "Answer"],
    "Answer, Unspecified (only use if no other Answer type applies)",
    "Answer"
  ]
  al_court_bundle.has_courtesy_copies = False
---
code: |
  taxlien_answer_attachment.filing_type = al_court_bundle.filing_type
---
code: |
  taxlien_answer_attachment.filing_component_filters = ['Lead Document']
  taxlien_answer_attachment.has_courtesy_copies = False
  #taxlien_answer_attachment.document_type_filters
---
code: |
  # Check that the land court is in available efile courts
  #efile_setup = "210" in available_efile_courts
  court_id = "210"
---
generic object: DAObject
code: |
  x.filing_description = ''
  x.reference_number = None
  x.filing_parties = ['users[0]']
  x.filing_action = 'efile'
---
generic object: EFCaseSearch
template: x.docket_lookup_choice
content: |
  Docket number
---
if: not can_check_efile
code: |
  users[0].is_form_filler = False
---
if: not is_initial_filing
code: |
  # TODO(brycew): harder, because it's affected by user_started_case
  is_defendant_filters = [
    CodeType('5788'),
    CodeType('598'),
    'Defendant/Appellee',
    'Defendant/Appellant',
    'Defendant/Petitioner',
    'Defendant/Respondent',
    'defendant',
  ]
---
if: not is_initial_filing
code: |
  is_plaintiff_filters = [
    CodeType('5779'),
    'Plaintiff/Appellee',
    'Plaintiff/Appellant',
    'Plaintiff/Petitioner',
    'Plaintiff/Respondent',
    'plaintiff',
  ]
---
# ##########################
# ## Register / Login
# id: eFile Login
# question: |
#   Connect to your eFileMA account
# subquestion: |
#   You need to use an eFileMA account to e-file this document. If you don't have an account yet, we can help you make one.

#   ${ collapse_template(what_is_efile_ma_template) }

#   <div class="alert alert-warning" role="alert">
#     <strong>Warning</strong>: you need to use an individual filer account, not a "firm" account
#     to file this petition.
#     <br/>
#     Choose "new account" if you have an existing account but it is managed by your firm.
#   </div>
# fields:
#   - I want to: user_login_or_make_new
#     datatype: radio
#     choices:
#       - Make a new account: new_account
#       - Login to my existing account: existing_account
#   - Email address: my_username
#     show if:
#       variable: user_login_or_make_new
#       is: existing_account
#     default: |
#       ${ showifdef("person_to_reg.email") or (user_info().email if user_logged_in() else '') }
#   - Password: my_password
#     datatype: ALVisiblePassword
#     js show if: |
#       val("user_login_or_make_new") == "existing_account" && !val("user_forgot_password")
#     default: |
#       ${ showifdef("new_password") }
#   - I forgot my password: user_forgot_password
#     datatype: yesno
#     show if:
#       variable: user_login_or_make_new
#       is: existing_account
# ---
# template: what_is_efile_ma_template
# subject: |
#   What is eFileMA?
# content: |
#   eFileMA is the Massachusetts Trial Court's official system for electronically
#   filing court documents. It is also called File and Serve.

#   This website can help you securely connect to eFileMA using your existing eFileMA
#   username and password, or to make a new account.

#   You can manage your account from the eFileMA website after we help you make it
#   here.
# ---
# code: |
#   # Firm registration exists, but we don't really need to handle it!
#   reg_type = 'INDIVIDUAL'
# ---
# id: registration info
# question: |
#   Create an efileMA account
# fields:
#   - Email address: person_to_reg.email
#     datatype: email
#     default: ${ user_info().email if user_logged_in() else ''}
#   - Phone number: person_to_reg.phone_number
#     datatype: al_international_phone
#   - Password: new_password
#     datatype: ALVisiblePassword
#     under text: |
#       ${ password_rules.get("validationmessage") }
#     validate: proxy_conn.is_valid_password
#   - note: |
#       ---
#   - First: person_to_reg.name.first
#   - Middle: person_to_reg.name.middle
#     required: False
#   - Last: person_to_reg.name.last
#   - Suffix: person_to_reg.name.suffix
#     required: False
#     code: name_suffix()
#   - note: |
#       ---
#   - Address: person_to_reg.address.address
#     address autocomplete: True
#   - Unit: person_to_reg.address.unit
#     required: False
#   - City: person_to_reg.address.city
#   - State: person_to_reg.address.state
#     code: states_list()
#   - Zip: person_to_reg.address.zip

# ---
# only sets:
#   - tyler_login
# code: |
#   if user_login_or_make_new == 'new_account':
#     person_to_reg.email
#     tyler_register_resp = proxy_conn.register_user(person_to_reg, registration_type=reg_type)
#     if not tyler_register_resp.is_ok():
#       log(f'Failed to register: {tyler_register_resp}')
#     register_status

#   elif showifdef('user_forgot_password'):
#     tyler_reset_password_resp = proxy_conn.reset_user_password(my_username)
#     reset_password_screen      
  
#   if not showifdef('user_forgot_password'):
#     # try logging in with new credentials or if it's a regular login
#     tyler_login_resp = proxy_conn.authenticate_user(tyler_email=my_username, tyler_password=my_password)
#     undefine("my_password")
#     if not tyler_login_resp.is_ok():
#       log(f'Failed to login: {tyler_login_resp}')
#       login_failed_screen
#     else:
#       log(word("You are now connected to your e-filing account"), "primary")
#   continue_stored_login = False # this is triggering when it shouldn't, maybe this is helpful?
#   tyler_login = True
# ---
# need:
#   - proxy_conn
#   - da_store
# code: |
#     tyler_header_name = f"TYLER-TOKEN-{jurisdiction_id.upper()}"
#     tyler_id_name = f"TYLER-ID-{jurisdiction_id}"
#     try:
#       if da_store.defined("EFSP-" + tyler_header_name):
#         proxy_conn.proxy_client.headers[tyler_header_name] = da_store.get("EFSP-" + tyler_header_name)
#         proxy_conn.proxy_client.headers[tyler_id_name] = da_store.get("EFSP-" + tyler_id_name)
#         tyler_user = proxy_conn.get_user()
#         if tyler_user.is_ok():
#           my_username = tyler_user.data.get('email')
#           if continue_stored_login:
#             log(word("You are now connected to your e-filing account") + f" ({my_username})", "primary")
#             logged_in_user_is_admin, logged_in_user_is_global_admin = get_tyler_roles(proxy_conn, None, tyler_user)
#             tyler_login = True
#           else:
#             da_store.set("EFSP-" + tyler_header_name, '')
#             da_store.set(tyler_user_id_key, '')
#     except NameError as err:
#       # Re-raise only name errors, so DA can work correctly
#       raise err
#     except Exception as ex:
#       log_error_and_notify(f"Error when trying to get da_store Tyler token: {ex}")

# ---
# if: can_connect_to_proxy
# id: unauth-register-done
# question: |
#   % if register_resp.is_ok():
#   Successfully registered
#   % else:
#   Something went wrong when we tried to register your account
#   % endif
# subquestion: |
#   % if register_resp.is_ok():
#   You will get an email from efile${ state_name_to_code(jurisdiction_id) } asking you to activate your account.

#   Click "next" when you have clicked the link to activate your account.

#   % else:
#   ${ debug_display(register_resp) }
#   % endif

# continue button field: register_status  


---
###########################
## Case Search
###########################
code: |
  court_case_search.can_file_non_indexed_case = False
---
code: |
  court_case_search.do_what_choice = "docket_lookup"
---
if: can_check_efile and court_case_search.do_what_choice == 'docket_lookup'
code: |
  court_case_search.court_id = "210" # all_courts.courts_from_docket_number(court_case_search.docket_number_from_user)[0].tyler_code
---
# Overriding a full block from case search
generic object: EFCaseSearch
code: |
  if len(x.maybe_user_partips) == 1:
    person_word = x.maybe_user_partips[0].name.familiar()
  else:
    person_word = 'one of them'

  if logged_in_user_is_admin:
    x.self_in_case_choices = [
      ['is_filing', word(f'I am filing for { person_word }')]
    ]
  else:
    x.self_in_case_choices = [
      ['is_self', word('Yes')],
      ['is_filing', word(f'No, but I am an attorney filing for { person_word }')]
    ]

  x.self_in_case_choices.extend([
    ['no', word('No')],
    ['idk', word("I do not know")]
  ])
---
id: user-wants-efile
question: |
  Do you want to e-file this document directly with the court?
subquestion: |
  You are able to electronically-file (e-file) this document with the land court!

  This means you don't have to print out the document. The court
  will communicate with you through your email or phone.

  You will have to provide your email to e-file this document. If you don't wish to provide that,
  you can choose not to efile.
fields:
  - Do you want to e-file?: user_wants_efile
    datatype: yesnoradio
---
id: not-in-case-kickout
event: not_in_case_kickout
question: |
  You might have the wrong case
subquestion: |
  % if len(target_case.maybe_user_partips) > 0:
  You said that you weren't ${ comma_and_list(target_case.maybe_user_partips, and_string='or') }. 
  % else:
  There aren't any participants in this case that you can be.
  % endif
  You need to already be a part of the case to file an response.

  Press the **Back** button to go back and select a different case or chose the opposing side.
---
# TODO: not needed if we can always say it should be public
id: document type
question: |
  Do you want your response to be publically visible, or impounded (restricted)?
subquestion: |
  See the [rules on impoundment procedure](https://www.mass.gov/trial-court-rules/uniform-rules-on-impoundment-procedure-rule-1-applicability-and-definitions#-c-impoundment-and-discovery)
  for more information.
fields:
  - no label: taxlien_answer_attachment.user_chosen_document_type
    input type: radio
    code: |
      list(reversed(taxlien_answer_attachment.filtered_document_type_options))
    default: ${ matching_tuple_option('public', taxlien_answer_attachment.filtered_document_type_options) }
---
code: |
  taxlien_answer_attachment.document_type_filters = ["public"] 
---
###################
## Payments
if: can_check_efile and no_payment_needed
code: |
  # Skip showing this screen to users, we already out set the payment method to be a waiver
  review_fees_screen = True
---
##################
## Email responses
template: email_confirmation
subject: |
  Important Tax Lien e-filing information
content: |
  <!DOCTYPE html>
  <html>
  <head>
    <title>MassAccess</title>
  </head>
  <body>
  <p>Hello ${ users[0].name },</p>
  <p><strong>Your Tax Lien Answer forms were sent to the Land Count. They will accept or reject your filing.</strong></p>
  <p>A person in the court has to accept the forms before they are officially filed.</p>
  <p><strong>What's next?</strong></p>
  <p>You should receive an email from Odyssey eFileMA (no-reply@efilingmail.tylertech.cloud). Your forms were given an Envelope Number, which will be used to track your filing.</p>
  <p>The court clerk will review what you filed.</p>
  <ul>
    <li>If it looks good, they will <strong>accept</strong> it. You will receive another email from Odyssey eFileMA explaining that the envelope was accepted. The email will include a link to a copy of your court forms with the clerk's stamp.</li>
    <li>If there is something wrong with the filing, they will <strong>reject</strong> it. You should receive another email from Odyssey eFileMA with an explanation of what needs to be fixed.</li>
  </ul>
  <p>Contact the Land Court at <a href="tel:+16177887470">(617)-788-7470</a> if you have questions.</p>
  <p>Thank you for using Court Forms Online.<br/>
  <a href="https://courtformsonline.org">Court Forms Online</a>
  </p>
  </body>
  </html>
---
template: neutral_email
subject: |
  Clerk response to your e-filed Tax Lien Answer
content: |
  <!DOCTYPE html>
  <html>
  <head>
    <title>MassAccess</title>
  </head>
  <body>
  <p>Hello ${ users[0].name },</p>
  <p><strong>The Land Court clerk has sent a response to your filing in {{ case_title }}.</strong></p>

  <p><q>{{ status }}</q></p>

  <p>{{ message_text }}</p>

  <p>Contact the Land Court at <a href="tel:+16177887470">(617)-788-7470</a> if you have questions.</p>

  <p>Thank you for using Court Forms Online.<br/>
  <a href="https://courtformsonline.org">Court Forms Online</a>
  </p>
  </body>
  </html>
---
template: acceptance_email
subject: |
  Clerk response to your e-filed Tax Lien Answer
content: |
  <!DOCTYPE html>
  <html>
  <head>
    <title>MassAccess</title>
  </head>
  <body>
  <p>Hello ${ users[0].name },</p>
  <p><strong>The Land Court clerk has sent a response to your filing in {{ case_title }}.</strong></p>

  <p><q>{{ status }}</q></p>

  <p>{{ message_text }}</p>

  <p>Contact the Land Court at <a href="tel:+16177887470">(617)-788-7470</a> if you have questions.</p>

  <p>Thank you for using Court Forms Online.<br/>
  <a href="https://courtformsonline.org">Court Forms Online</a>
  </p>
  </body>
  </html>
---
template: rejection_email
subject: |
  Clerk response to your e-filed Tax Lien Answer
content: |
  <!DOCTYPE html>
  <html>
  <head>
    <title>MassAccess</title>
  </head>
  <body>
  <p>Hello ${ users[0].name },</p>
  <p><strong>The Land Court clerk has sent a response to your filing in {{ case_title }}.</strong></p>

  <p><q>{{ status }}</q></p>

  <p>{{ message_text }}</p>

  <p>Contact the Land Court at <a href="tel:+16177887470">(617)-788-7470</a> if you have questions.</p>

  <p>Thank you for using Court Forms Online.<br/>
  <a href="https://courtformsonline.org">Court Forms Online</a>
  </p>
  </body>
  </html>
---